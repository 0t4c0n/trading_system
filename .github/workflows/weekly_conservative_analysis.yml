# .github/workflows/weekly_conservative_analysis.yml
name: Enhanced Conservative Stock Analysis with Trading Levels

on:
  schedule:
    # SÃ¡bados a las 10:00 AM EspaÃ±a (9:00 AM UTC)
    - cron: '0 9 * * 6'
  workflow_dispatch:  # Permitir ejecuciÃ³n manual

# PERMISOS NECESARIOS PARA GITHUB PAGES Y COMMITS
permissions:
  contents: write
  pages: write
  id-token: write

# Asegurar que solo un workflow corra a la vez
concurrency:
  group: "enhanced-conservative-analysis"
  cancel-in-progress: false

jobs:
  enhanced-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 150  # 2.5 horas para anÃ¡lisis completo
    
    # Configurar entorno para GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Historial completo para anÃ¡lisis de consistencia
        
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache dependencies mejorado
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-enhanced-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-enhanced-
          ${{ runner.os }}-pip-
        
    - name: Instalar dependencias
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verificar archivos de configuraciÃ³n y estado del historial
      run: |
        echo "=== VERIFICANDO CONFIGURACION MEJORADA CON HISTORIAL ==="
        if [ ! -f "current_portfolio.json" ]; then
          echo "ERROR: current_portfolio.json no encontrado"
          exit 1
        fi
        echo "âœ… ConfiguraciÃ³n verificada"
        
        # Verificar estado del historial existente
        echo "ğŸ“š Archivos histÃ³ricos existentes:"
        ls -la *_*.json 2>/dev/null | grep -E "(weekly_screening_results_|consistency_analysis_|rotation_recommendations_)" || echo "   No hay archivos histÃ³ricos previos"
        ls -la ENHANCED_WEEKLY_REPORT_*.md 2>/dev/null || echo "   No hay reportes histÃ³ricos previos"
      env:
        PYTHONUNBUFFERED: 1
        
    - name: Configurar variables de entorno para anÃ¡lisis mejorado
      run: |
        echo "REPORT_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV
        echo "ANALYSIS_START_TIME=$(date -u +%H:%M)" >> $GITHUB_ENV
        echo "ENHANCED_MODE=true" >> $GITHUB_ENV
        echo "AUTO_HISTORY=true" >> $GITHUB_ENV
        
    - name: 1. Screening conservador mejorado con historial automÃ¡tico
      run: |
        echo "STEP 1: Screening completo 3,000+ acciones con gestiÃ³n automÃ¡tica de historial..."
        echo "El sistema archivarÃ¡ automÃ¡ticamente resultados anteriores (si existen)"
        echo "Tiempo estimado: 15-25 minutos para anÃ¡lisis completo"
        
        python conservative_screener.py
        
        if [ -f "weekly_screening_results.json" ]; then
          echo "SUCCESS: Screening completado con gestiÃ³n automÃ¡tica de historial"
          # Verificar que el archivo contiene datos vÃ¡lidos
          python -c "import json; data=json.load(open('weekly_screening_results.json')); print(f'Resultados: {len(data.get(\"detailed_results\", []))}')"
        else
          echo "ERROR: Error en screening conservador"
          exit 1
        fi
      env:
        PYTHONUNBUFFERED: 1

    - name: 1.1. FORZAR creaciÃ³n de archivo histÃ³rico de screening
      run: |
        echo "ğŸ”§ FORZANDO creaciÃ³n de archivo histÃ³rico de screening..."
        DATE_STAMP=$(date +%Y%m%d)
        
        if [ -f "weekly_screening_results.json" ]; then
          # Crear copia histÃ³rica con timestamp
          cp weekly_screening_results.json "weekly_screening_results_${DATE_STAMP}.json"
          echo "âœ… Archivo histÃ³rico creado: weekly_screening_results_${DATE_STAMP}.json"
          ls -la weekly_screening_results_${DATE_STAMP}.json
        else
          echo "âŒ No se puede crear histÃ³rico - archivo principal no existe"
        fi
        
    - name: 2. Analizar consistencia histÃ³rica con archivos mejorados
      run: |
        echo "STEP 2: AnÃ¡lisis de consistencia (5 semanas) con gestiÃ³n de historial..."
        echo "El sistema archivarÃ¡ automÃ¡ticamente el anÃ¡lisis anterior (si existe)"
        echo "BuscarÃ¡ archivos histÃ³ricos en mÃºltiples formatos para mÃ¡xima compatibilidad"
        
        python consistency_analyzer.py
        
        if [ -f "consistency_analysis.json" ]; then
          echo "SUCCESS: AnÃ¡lisis de consistencia completado con gestiÃ³n de historial"
          python verify_consistency.py
        else
          echo "ERROR: Error en anÃ¡lisis de consistencia"
          exit 1
        fi
      env:
        PYTHONUNBUFFERED: 1

    - name: 2.1. FORZAR creaciÃ³n de archivo histÃ³rico de consistencia
      run: |
        echo "ğŸ”§ FORZANDO creaciÃ³n de archivo histÃ³rico de consistencia..."
        DATE_STAMP=$(date +%Y%m%d)
        
        if [ -f "consistency_analysis.json" ]; then
          # Crear copia histÃ³rica con timestamp
          cp consistency_analysis.json "consistency_analysis_${DATE_STAMP}.json"
          echo "âœ… Archivo histÃ³rico creado: consistency_analysis_${DATE_STAMP}.json"
          ls -la consistency_analysis_${DATE_STAMP}.json
        else
          echo "âŒ No se puede crear histÃ³rico - archivo principal no existe"
        fi
        
    - name: 3. Generar recomendaciones de rotaciÃ³n con historial
      run: |
        echo "STEP 3: Recomendaciones de rotaciÃ³n con anÃ¡lisis multifactorial y gestiÃ³n de historial..."
        echo "El sistema archivarÃ¡ automÃ¡ticamente las recomendaciones anteriores (si existen)"
        
        python rotation_recommender.py
        
        if [ -f "rotation_recommendations.json" ]; then
          echo "SUCCESS: Recomendaciones de rotaciÃ³n completadas con gestiÃ³n de historial"
          python verify_rotation.py
        else
          echo "ERROR: Error en recomendaciones de rotaciÃ³n"
          exit 1
        fi
      env:
        PYTHONUNBUFFERED: 1

    - name: 3.1. FORZAR creaciÃ³n de archivo histÃ³rico de rotaciÃ³n
      run: |
        echo "ğŸ”§ FORZANDO creaciÃ³n de archivo histÃ³rico de rotaciÃ³n..."
        DATE_STAMP=$(date +%Y%m%d)
        
        if [ -f "rotation_recommendations.json" ]; then
          # Crear copia histÃ³rica con timestamp
          cp rotation_recommendations.json "rotation_recommendations_${DATE_STAMP}.json"
          echo "âœ… Archivo histÃ³rico creado: rotation_recommendations_${DATE_STAMP}.json"
          ls -la rotation_recommendations_${DATE_STAMP}.json
        else
          echo "âŒ No se puede crear histÃ³rico - archivo principal no existe"
        fi
        
    - name: 4. Crear reporte semanal mejorado con historial
      run: |
        echo "STEP 4: Generando reporte semanal mejorado con niveles de trading y gestiÃ³n de historial..."
        echo "El sistema gestionarÃ¡ automÃ¡ticamente el historial de reportes"
        
        python create_weekly_report.py
        
        echo "Verificando reportes generados..."
        if [ -f "docs/data.json" ]; then
          echo "SUCCESS: Dashboard data.json generado"
          python verify_dashboard.py
        else
          echo "ERROR: Error generando dashboard data"
          exit 1
        fi
        
        # Verificar reportes Markdown
        ENHANCED_REPORT=$(ls ENHANCED_WEEKLY_REPORT_*.md 2>/dev/null | head -1)
        REGULAR_REPORT=$(ls WEEKLY_REPORT_*.md 2>/dev/null | head -1)
        
        if [ -n "$ENHANCED_REPORT" ]; then
          echo "SUCCESS: Reporte mejorado generado: $ENHANCED_REPORT"
        elif [ -n "$REGULAR_REPORT" ]; then
          echo "SUCCESS: Reporte regular generado: $REGULAR_REPORT"
        else
          echo "WARNING: No se generÃ³ reporte Markdown (puede ser normal)"
        fi
      env:
        PYTHONUNBUFFERED: 1
        
    - name: ğŸ”§ DEBUG - Verificar archivos histÃ³ricos FORZADOS
      run: |
        echo "=== ğŸ”§ VERIFICACIÃ“N DEBUG DE ARCHIVOS HISTÃ“RICOS FORZADOS ==="
        DATE_STAMP=$(date +%Y%m%d)
        
        echo "ğŸ“ Archivos con patrÃ³n histÃ³rico esperado:"
        ls -la *_${DATE_STAMP}.json 2>/dev/null || echo "   âŒ No hay archivos con fecha de hoy"
        
        echo "ğŸ“ Todos los archivos histÃ³ricos (con fecha):"
        ls -la *_*.json 2>/dev/null | grep -v "weekly_screening_results.json" | head -10 || echo "   âŒ No hay archivos histÃ³ricos"
        
        echo "ğŸ“ Reportes histÃ³ricos:"
        ls -la ENHANCED_WEEKLY_REPORT_*.md 2>/dev/null | head -5 || echo "   âŒ No hay reportes histÃ³ricos"
        
        echo "ğŸ“Š CONTEO TOTAL DESPUÃ‰S DE FORZADO:"
        HIST_SCREENING=$(ls weekly_screening_results_*.json 2>/dev/null | wc -l)
        HIST_CONSISTENCY=$(ls consistency_analysis_*.json 2>/dev/null | wc -l)
        HIST_ROTATION=$(ls rotation_recommendations_*.json 2>/dev/null | wc -l)
        HIST_REPORTS=$(ls ENHANCED_WEEKLY_REPORT_*.md 2>/dev/null | wc -l)
        echo "   - Screening histÃ³ricos: $HIST_SCREENING"
        echo "   - Consistencia histÃ³ricos: $HIST_CONSISTENCY"  
        echo "   - RotaciÃ³n histÃ³ricos: $HIST_ROTATION"
        echo "   - Reportes histÃ³ricos: $HIST_REPORTS"
        
        TOTAL_HISTORICAL=$((HIST_SCREENING + HIST_CONSISTENCY + HIST_ROTATION + HIST_REPORTS))
        echo "   - TOTAL HISTÃ“RICOS: $TOTAL_HISTORICAL"
        
        if [ $TOTAL_HISTORICAL -eq 0 ]; then
          echo "ğŸš¨ CRITICAL: No se generaron archivos histÃ³ricos"
          exit 1
        else
          echo "âœ… SUCCESS: Se generaron $TOTAL_HISTORICAL archivos histÃ³ricos"
        fi
        
    - name: Verificar archivos generados y calidad con historial
      run: |
        python verify_generated_files.py
        
        echo ""
        echo "=== VERIFICACIÃ“N DE ARCHIVOS HISTÃ“RICOS GENERADOS ==="
        echo "ğŸ“ Archivos principales (actuales):"
        ls -la weekly_screening_results.json consistency_analysis.json rotation_recommendations.json docs/data.json 2>/dev/null || echo "   Algunos archivos principales faltantes"
        
        echo ""
        echo "ğŸ“š Archivos histÃ³ricos (con fecha):"
        ls -la weekly_screening_results_*.json 2>/dev/null | tail -3 || echo "   No hay archivos de screening histÃ³ricos"
        ls -la consistency_analysis_*.json 2>/dev/null | tail -3 || echo "   No hay archivos de consistencia histÃ³ricos"
        ls -la rotation_recommendations_*.json 2>/dev/null | tail -3 || echo "   No hay archivos de rotaciÃ³n histÃ³ricos"
        ls -la ENHANCED_WEEKLY_REPORT_*.md 2>/dev/null | tail -3 || echo "   No hay reportes histÃ³ricos"
        
        echo ""
        echo "ğŸ“Š Conteo total de archivos histÃ³ricos:"
        HIST_SCREENING=$(ls weekly_screening_results_*.json 2>/dev/null | wc -l)
        HIST_CONSISTENCY=$(ls consistency_analysis_*.json 2>/dev/null | wc -l)
        HIST_ROTATION=$(ls rotation_recommendations_*.json 2>/dev/null | wc -l)
        HIST_REPORTS=$(ls ENHANCED_WEEKLY_REPORT_*.md 2>/dev/null | wc -l)
        echo "   - Screening histÃ³ricos: $HIST_SCREENING"
        echo "   - Consistencia histÃ³ricos: $HIST_CONSISTENCY"
        echo "   - RotaciÃ³n histÃ³ricos: $HIST_ROTATION"
        echo "   - Reportes histÃ³ricos: $HIST_REPORTS"
      env:
        PYTHONUNBUFFERED: 1
        
    - name: Configurar Git para commits automÃ¡ticos
      run: |
        git config --global user.name 'Enhanced Conservative Bot'
        git config --global user.email 'actions@github.com'
        
    - name: Generar mensaje de commit inteligente
      run: |
        python generate_commit_message.py
        
        # Mostrar el mensaje generado
        echo "=== MENSAJE DE COMMIT GENERADO ==="
        cat commit_message.txt
        echo "================================="
      env:
        PYTHONUNBUFFERED: 1
        
    - name: ğŸ”§ COMMIT FORZADO con gestiÃ³n de historial CORREGIDA
      run: |
        echo "=== ğŸ”§ INICIANDO COMMIT FORZADO CON HISTORIAL ==="
        
        # AÃ±adir TODOS los archivos, incluyendo histÃ³ricos
        echo "ğŸ“ AÃ±adiendo archivos principales..."
        git add weekly_screening_results.json || echo "Skip weekly_screening_results.json"
        git add consistency_analysis.json || echo "Skip consistency_analysis.json"
        git add rotation_recommendations.json || echo "Skip rotation_recommendations.json"
        git add docs/data.json || echo "Skip docs/data.json"
        
        echo "ğŸ“š AÃ±adiendo archivos histÃ³ricos FORZADAMENTE..."
        git add weekly_screening_results_*.json || echo "No historic screening files"
        git add consistency_analysis_*.json || echo "No historic consistency files"
        git add rotation_recommendations_*.json || echo "No historic rotation files"
        git add ENHANCED_WEEKLY_REPORT_*.md || echo "No historic reports"
        git add WEEKLY_REPORT_*.md || echo "No regular reports"
        
        # TambiÃ©n aÃ±adir cualquier otro archivo generado
        echo "ğŸ”§ AÃ±adiendo otros archivos generados..."
        git add momentum_responsive_results_*.json || echo "No momentum files"
        git add ultra_conservative_results_*.json || echo "No ultra conservative files"
        
        echo "=== ğŸ” VERIFICANDO ARCHIVOS AÃ‘ADIDOS ==="
        git status --porcelain
        STAGED_FILES=$(git status --porcelain | wc -l)
        echo "Archivos en staging: $STAGED_FILES"
        
        if [ $STAGED_FILES -eq 0 ]; then
          echo "ğŸš¨ FORZANDO AÃ‘ADIR TODO CON ADD --ALL"
          git add --all
          git status --porcelain
          STAGED_FILES_ALL=$(git status --porcelain | wc -l)
          echo "Archivos despuÃ©s de --all: $STAGED_FILES_ALL"
        fi
        
        echo "=== ğŸ“ REALIZANDO COMMIT FORZADO ==="
        FINAL_STAGED=$(git status --porcelain | wc -l)
        if [ $FINAL_STAGED -gt 0 ]; then
          # Commit con mensaje personalizado
          if [ -f "commit_message.txt" ]; then
            git commit -F commit_message.txt
          else
            git commit -m "ğŸ”§ FIXED: Enhanced Weekly Analysis + Forced History Management $(date +%Y-%m-%d)"
          fi
          
          echo "=== ğŸš€ PUSHING CAMBIOS ==="
          git push
          echo "âœ… SUCCESS: Archivos histÃ³ricos commiteados CORRECTAMENTE"
          
          echo "=== ğŸ“‹ RESUMEN DE ARCHIVOS COMMITEADOS ==="
          git show --name-only --pretty=format: HEAD | sort | head -20
        else
          echo "âŒ CRITICAL: No hay archivos para commitear despuÃ©s de forzar"
          echo "Listando todos los archivos generados:"
          find . -name "*.json" -o -name "*.md" | grep -E "(weekly_screening|consistency|rotation|ENHANCED)" | head -10
          exit 1
        fi
        
    - name: Configurar GitHub Pages
      uses: actions/configure-pages@v5
      
    - name: Subir artefactos para Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs'
        
    - name: Desplegar a GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ğŸ‰ Resumen final con historial FORZADO y mÃ©tricas MEJORADO
      run: |
        echo "ğŸ‰ ===== ANÃLISIS MEJORADO COMPLETADO CON HISTORIAL FORZADO ====="
        echo "ğŸ• Iniciado: $ANALYSIS_START_TIME UTC"
        echo "ğŸ• Finalizado: $(date -u +%H:%M) UTC"
        echo ""
        echo "ğŸ“Š ARCHIVOS PRINCIPALES GENERADOS:"
        ls -la *.json *.md 2>/dev/null | grep -E "(weekly_screening_results\.json|consistency_analysis\.json|rotation_recommendations\.json|ENHANCED_WEEKLY_REPORT_.*\.md)" || echo "Sin archivos principales"
        echo ""
        echo "ğŸ“š GESTIÃ“N DE HISTORIAL FORZADA - CORREGIDA:"
        echo "ğŸ”§ NUEVO: Archivos histÃ³ricos ahora se crean FORZADAMENTE despuÃ©s de cada paso"
        TOTAL_HISTORICAL=$(ls *_*.json ENHANCED_WEEKLY_REPORT_*.md 2>/dev/null | wc -l)
        echo "ğŸ“ Total archivos histÃ³ricos FORZADOS: $TOTAL_HISTORICAL"
        echo ""
        if [ $TOTAL_HISTORICAL -gt 0 ]; then
          echo "ğŸ“‹ Archivos histÃ³ricos FORZADOS generados:"
          ls -lt *_*.json ENHANCED_WEEKLY_REPORT_*.md 2>/dev/null | head -10
        fi
        echo ""
        echo "ğŸŒ DASHBOARD: ${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "ğŸ“ˆ PRÃ“XIMAS EJECUCIONES:"
        echo "ğŸ”„ PrÃ³xima ejecuciÃ³n: SÃ¡bados 10:00 AM EspaÃ±a"
        echo "âš¡ EjecuciÃ³n manual disponible en Actions tab"
        echo "ğŸ“š Historial forzado: âœ… IMPLEMENTADO Y FUNCIONANDO"
        echo "ğŸ”§ GestiÃ³n histÃ³rica: PROACTIVA (crea archivos siempre)"
        echo "=============================================="