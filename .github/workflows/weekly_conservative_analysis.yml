# .github/workflows/daily_conservative_analysis.yml
name: Daily Conservative Stock Analysis with MA50 Bonus

on:
  schedule:
    # Lunes a viernes a las 9:00 AM EspaÃ±a (8:00 UTC)
    - cron: '0 8 * * 1-5'
  workflow_dispatch:  # Permitir ejecuciÃ³n manual

# PERMISOS NECESARIOS PARA GITHUB PAGES Y COMMITS
permissions:
  contents: write
  pages: write
  id-token: write

# Asegurar que solo un workflow corra a la vez
concurrency:
  group: "daily-conservative-analysis"
  cancel-in-progress: false

jobs:
  daily-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 horas para anÃ¡lisis completo diario
    
    # Configurar entorno para GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Historial completo para anÃ¡lisis de consistencia
        
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache dependencies optimizado para ejecuciÃ³n diaria
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-daily-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-daily-
          ${{ runner.os }}-pip-
        
    - name: Instalar dependencias
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verificar configuraciÃ³n y estado histÃ³rico diario
      run: |
        echo "=== VERIFICANDO CONFIGURACION PARA EJECUCION DIARIA ==="
        if [ ! -f "current_portfolio.json" ]; then
          echo "ERROR: current_portfolio.json no encontrado"
          exit 1
        fi
        echo "âœ… Portfolio configurado para monitorizaciÃ³n diaria"
        
        # Verificar archivos histÃ³ricos recientes (Ãºltimos 7 dÃ­as)
        echo "ğŸ“š Archivos del historial diario (Ãºltimos 7 dÃ­as):"
        find . -name "*_*.json" -mtime -7 2>/dev/null | grep -E "(weekly_screening_results_|consistency_analysis_|rotation_recommendations_)" | head -10 || echo "   Iniciando historial diario"
        
        echo "ğŸ”„ MODO: EjecuciÃ³n diaria para trades de ~1 mes"
        echo "ğŸ¯ OBJETIVO: Monitorizar oportunidades sin rotaciÃ³n excesiva"
        echo "ğŸ•˜ HORARIO: L-V 9:00 AM EspaÃ±a (post-apertura europea)"
      env:
        PYTHONUNBUFFERED: 1
        
    - name: Configurar variables de entorno para anÃ¡lisis diario
      run: |
        echo "REPORT_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV
        echo "ANALYSIS_START_TIME=$(date -u +%H:%M)" >> $GITHUB_ENV
        echo "ENHANCED_MODE=true" >> $GITHUB_ENV
        echo "DAILY_MODE=true" >> $GITHUB_ENV
        echo "AUTO_HISTORY=true" >> $GITHUB_ENV
        echo "EXECUTION_FREQUENCY=daily" >> $GITHUB_ENV
        
    - name: 1. Screening diario con bonus MA50
      run: |
        echo "ğŸ” === SCREENING DIARIO CON BONUS MA50 ==="
        echo "ğŸŒŸ Sistema: MA50 priority con +22 puntos por rebote alcista"
        echo "ğŸ“… Frecuencia: Diaria (L-V 9:00 AM EspaÃ±a)"
        echo "ğŸ¯ Objetivo: Trades de ~1 mes con gestiÃ³n diaria de exits"
        
        python conservative_screener.py
        
        echo "âœ… Screening diario completado"
        ls -la weekly_screening_results.json momentum_responsive_results_*.json 2>/dev/null || echo "Verificando archivos generados..."
      env:
        PYTHONUNBUFFERED: 1

    - name: 1.1. Crear archivo histÃ³rico de screening diario
      run: |
        echo "ğŸ”§ Creando archivo histÃ³rico de screening diario..."
        DATE_STAMP=$(date +%Y%m%d)
        
        if [ -f "weekly_screening_results.json" ]; then
          cp weekly_screening_results.json "weekly_screening_results_${DATE_STAMP}.json"
          echo "âœ… Archivo histÃ³rico creado: weekly_screening_results_${DATE_STAMP}.json"
          ls -la weekly_screening_results_${DATE_STAMP}.json
        else
          echo "âŒ No se puede crear histÃ³rico - archivo principal no existe"
        fi
        
    - name: 2. AnÃ¡lisis de consistencia adaptado para ejecuciÃ³n diaria
      run: |
        echo "ğŸ“Š === ANALISIS DE CONSISTENCIA DIARIO ==="
        echo "ğŸ”„ Adaptado para: DetecciÃ³n de tendencias en ejecuciÃ³n diaria"
        echo "â±ï¸ Ventana: Ãšltimos 7 dÃ­as de screening para patrones"
        
        python consistency_analyzer.py
        
        echo "âœ… AnÃ¡lisis de consistencia diario completado"
        ls -la consistency_analysis.json consistency_analysis_*.json 2>/dev/null || echo "Verificando archivos de consistencia..."
      env:
        PYTHONUNBUFFERED: 1

    - name: 2.1. Crear archivo histÃ³rico de consistencia diaria
      run: |
        echo "ğŸ”§ Creando archivo histÃ³rico de consistencia diaria..."
        DATE_STAMP=$(date +%Y%m%d)
        
        if [ -f "consistency_analysis.json" ]; then
          cp consistency_analysis.json "consistency_analysis_${DATE_STAMP}.json"
          echo "âœ… Archivo histÃ³rico creado: consistency_analysis_${DATE_STAMP}.json"
          ls -la consistency_analysis_${DATE_STAMP}.json
        else
          echo "âŒ No se puede crear histÃ³rico - archivo principal no existe"
        fi
        
    - name: 3. Recomendaciones optimizadas para trades mensuales
      run: |
        echo "ğŸ’¡ === RECOMENDACIONES PARA TRADES MENSUALES ==="
        echo "ğŸ¯ FilosofÃ­a: Trades de ~1 mes con criterios estrictos de rotaciÃ³n"
        echo "âš ï¸ Solo rotar cuando:"
        echo "   - PosiciÃ³n cerca del stop loss (2-3%)"
        echo "   - Sin momentum por 3+ dÃ­as consecutivos" 
        echo "   - Oportunidad 30+ puntos superior"
        echo "   - Deterioro fundamental"
        
        python rotation_recommender.py
        
        echo "âœ… Recomendaciones mensuales generadas"
        ls -la rotation_recommendations.json rotation_recommendations_*.json 2>/dev/null || echo "Verificando recomendaciones..."
      env:
        PYTHONUNBUFFERED: 1

    - name: 3.1. Crear archivo histÃ³rico de recomendaciones diarias
      run: |
        echo "ğŸ”§ Creando archivo histÃ³rico de recomendaciones diarias..."
        DATE_STAMP=$(date +%Y%m%d)
        
        if [ -f "rotation_recommendations.json" ]; then
          cp rotation_recommendations.json "rotation_recommendations_${DATE_STAMP}.json"
          echo "âœ… Archivo histÃ³rico creado: rotation_recommendations_${DATE_STAMP}.json"
          ls -la rotation_recommendations_${DATE_STAMP}.json
        else
          echo "âŒ No se puede crear histÃ³rico - archivo principal no existe"
        fi
        
    - name: 4. Generar reporte diario optimizado
      run: |
        echo "ğŸ“‹ === GENERANDO REPORTE DIARIO ==="
        echo "ğŸ“… Tipo: Daily Market Analysis + Monthly Trading Recommendations"
        
        python create_weekly_report.py
        
        echo "âœ… Reporte diario generado"
        ls -la ENHANCED_WEEKLY_REPORT_*.md docs/data.json 2>/dev/null || echo "Verificando reporte y dashboard..."
      env:
        PYTHONUNBUFFERED: 1
        
    - name: 5. Generar mensaje de commit inteligente para ejecuciÃ³n diaria
      run: |
        echo "ğŸ“ === GENERANDO COMMIT MESSAGE DIARIO ==="
        
        # Crear mensaje especÃ­fico para ejecuciÃ³n diaria
        cat > commit_message.txt << 'EOF'
ğŸ”„ Daily Analysis: MA50 Bonus System + Monthly Trading Focus

ğŸ“… Execution: Daily monitoring for ~1 month trades
ğŸŒŸ MA50 Bonus: +22pts for bullish rebounds  
ğŸ¯ Philosophy: Daily screening, monthly rotation criteria
âš¡ Features: Weekly ATR + Strict rotation thresholds
ğŸ•˜ Schedule: Mon-Fri 9:00 AM Spain (post-EU open)

ğŸ“Š Daily Stats:
- Screening: Conservative momentum with MA50 priority
- Consistency: 7-day pattern detection
- Recommendations: Only high-conviction rotations
- Target: 1-month holds with daily exit management

ğŸ”§ Optimizations Applied:
- MA50 stop loss bonus system
- Daily execution frequency  
- Reduced rotation frequency
- Enhanced risk management

[Daily Conservative Analysis $(date +%Y-%m-%d)]
EOF

        echo "=== MENSAJE DE COMMIT DIARIO GENERADO ==="
        cat commit_message.txt
        echo "================================="
      env:
        PYTHONUNBUFFERED: 1
        
    - name: Configurar Git para commits diarios automÃ¡ticos
      run: |
        git config --global user.name 'Daily Conservative Bot'
        git config --global user.email 'actions@github.com'
        
    - name: 6. Commit diario con gestiÃ³n histÃ³rica optimizada
      run: |
        echo "=== ğŸ”§ INICIANDO COMMIT DIARIO ==="
        
        # AÃ±adir archivos principales del dÃ­a
        echo "ğŸ“ AÃ±adiendo archivos principales del anÃ¡lisis diario..."
        git add weekly_screening_results.json || echo "Skip weekly_screening_results.json"
        git add consistency_analysis.json || echo "Skip consistency_analysis.json"  
        git add rotation_recommendations.json || echo "Skip rotation_recommendations.json"
        git add docs/data.json || echo "Skip docs/data.json"
        
        # AÃ±adir archivos histÃ³ricos diarios
        echo "ğŸ“š AÃ±adiendo archivos histÃ³ricos diarios..."
        git add weekly_screening_results_*.json || echo "No historic screening files"
        git add consistency_analysis_*.json || echo "No historic consistency files"
        git add rotation_recommendations_*.json || echo "No historic rotation files"
        git add ENHANCED_WEEKLY_REPORT_*.md || echo "No historic reports"
        git add momentum_responsive_results_*.json || echo "No momentum files"
        
        echo "=== ğŸ” VERIFICANDO ARCHIVOS DIARIOS AÃ‘ADIDOS ==="
        git status --porcelain
        STAGED_FILES=$(git status --porcelain | wc -l)
        echo "Archivos en staging: $STAGED_FILES"
        
        if [ $STAGED_FILES -eq 0 ]; then
          echo "ğŸš¨ AÃ‘ADIENDO TODOS LOS ARCHIVOS DIARIOS"
          git add --all
          git status --porcelain
          STAGED_FILES_ALL=$(git status --porcelain | wc -l)
          echo "Archivos despuÃ©s de --all: $STAGED_FILES_ALL"
        fi
        
        echo "=== ğŸ“ REALIZANDO COMMIT DIARIO ==="
        FINAL_STAGED=$(git status --porcelain | wc -l)
        if [ $FINAL_STAGED -gt 0 ]; then
          git commit -F commit_message.txt
          
          echo "=== ğŸš€ PUSHING CAMBIOS DIARIOS ==="
          git push
          echo "âœ… SUCCESS: AnÃ¡lisis diario commiteado correctamente"
          
          echo "=== ğŸ“‹ RESUMEN DE ARCHIVOS DIARIOS COMMITEADOS ==="
          git show --name-only --pretty=format: HEAD | sort | head -15
        else
          echo "âŒ CRITICAL: No hay archivos para commitear en anÃ¡lisis diario"
          exit 1
        fi
        
    - name: Configurar GitHub Pages
      uses: actions/configure-pages@v5
      
    - name: Subir artefactos para Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs'
        
    - name: Desplegar a GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: 7. Resumen final del anÃ¡lisis diario
      run: |
        echo "ğŸ‰ ===== ANÃLISIS DIARIO COMPLETADO ====="
        echo "ğŸ• Iniciado: $ANALYSIS_START_TIME UTC"
        echo "ğŸ• Finalizado: $(date -u +%H:%M) UTC"
        echo "ğŸ“… Fecha: $(date +%Y-%m-%d)"
        echo ""
        echo "ğŸ“Š ARCHIVOS DIARIOS GENERADOS:"
        ls -la *.json *.md 2>/dev/null | grep -E "(weekly_screening_results\.json|consistency_analysis\.json|rotation_recommendations\.json|ENHANCED_WEEKLY_REPORT_*.md)" || echo "Sin archivos principales"
        echo ""
        echo "ğŸ”„ CONFIGURACIÃ“N DIARIA APLICADA:"
        echo "ğŸŒŸ MA50 Bonus System: +22pts por rebote alcista"
        echo "ğŸ“… Frecuencia: Lunes-Viernes 9:00 AM EspaÃ±a"
        echo "ğŸ¯ FilosofÃ­a: Trades de ~1 mes con monitorizaciÃ³n diaria"
        echo "âš ï¸ Rotaciones: Solo con criterios estrictos"
        echo ""
        echo "ğŸ“š GESTIÃ“N HISTÃ“RICA DIARIA:"
        TOTAL_HISTORICAL=$(ls *_*.json ENHANCED_WEEKLY_REPORT_*.md 2>/dev/null | wc -l)
        echo "ğŸ“ Total archivos histÃ³ricos: $TOTAL_HISTORICAL"
        echo ""
        if [ $TOTAL_HISTORICAL -gt 0 ]; then
          echo "ğŸ“‹ Archivos histÃ³ricos recientes (Ãºltimos 5):"
          ls -lt *_*.json ENHANCED_WEEKLY_REPORT_*.md 2>/dev/null | head -5
        fi
        echo ""
        echo "ğŸŒ DASHBOARD: ${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "ğŸ“ˆ PRÃ“XIMAS EJECUCIONES:"
        echo "ğŸ”„ PrÃ³xima ejecuciÃ³n: Lunes-Viernes 9:00 AM EspaÃ±a"
        echo "âš¡ EjecuciÃ³n manual disponible en Actions tab"
        echo "ğŸ¯ Sistema: Optimizado para trades mensuales con gestiÃ³n diaria"
        echo "ğŸŒŸ Bonus MA50: Sistema implementado y funcionando"
        echo "=============================================="
      env:
        PYTHONUNBUFFERED: 1