# .github/workflows/weekly_conservative_analysis.yml
name: Enhanced Conservative Stock Analysis with Trading Levels

on:
  schedule:
    # SÃ¡bados a las 10:00 AM EspaÃ±a (9:00 AM UTC)
    - cron: '0 9 * * 6'
  workflow_dispatch:  # Permitir ejecuciÃ³n manual

# PERMISOS NECESARIOS PARA GITHUB PAGES Y COMMITS
permissions:
  contents: write
  pages: write
  id-token: write

# Asegurar que solo un workflow corra a la vez
concurrency:
  group: "enhanced-conservative-analysis"
  cancel-in-progress: false

jobs:
  enhanced-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 150  # 2.5 horas para anÃ¡lisis completo
    
    # Configurar entorno para GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Historial completo para anÃ¡lisis de consistencia
        
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache dependencies mejorado
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-enhanced-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-enhanced-
          ${{ runner.os }}-pip-
        
    - name: Instalar dependencias
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verificar archivos de configuraciÃ³n y estado del historial
      run: |
        echo "=== VERIFICANDO CONFIGURACIÃ“N MEJORADA CON HISTORIAL ==="
        if [ ! -f "current_portfolio.json" ]; then
          echo "âš ï¸ current_portfolio.json no encontrado - se crearÃ¡ ejemplo"
        else
          echo "âœ“ current_portfolio.json encontrado"
          echo "Posiciones actuales:"
          python3 -c "
import json
try:
    with open('current_portfolio.json', 'r') as f:
        data = json.load(f)
    positions = list(data.get('positions', {}).keys())
    print(f'ğŸ“‚ {len(positions)} posiciones: {positions}')
    print(f'ğŸ’° Cash disponible: \$\${data.get(\"cash\", 0):,.2f}')
except Exception as e:
    print(f'âŒ Error leyendo portfolio: {e}')
          "
        fi
        
        echo ""
        echo "=== VERIFICANDO SCRIPTS PRINCIPALES ==="
        for script in "conservative_screener.py" "consistency_analyzer.py" "rotation_recommender.py" "create_weekly_report.py"; do
          if [ -f "$script" ]; then
            echo "âœ“ $script encontrado"
          else
            echo "âŒ $script NO ENCONTRADO"
            exit 1
          fi
        done
        
        echo ""
        echo "=== ESTADO DEL HISTORIAL ACTUAL ==="
        
        # Contar archivos histÃ³ricos por tipo
        hist_screening=$(ls weekly_screening_results_*.json 2>/dev/null | wc -l)
        hist_ultra=$(ls ultra_conservative_results_*.json 2>/dev/null | wc -l)
        hist_consistency=$(ls consistency_analysis_*.json 2>/dev/null | wc -l)
        hist_rotation=$(ls rotation_recommendations_*.json 2>/dev/null | wc -l)
        hist_reports=$(ls *WEEKLY_REPORT*.md 2>/dev/null | wc -l)
        
        echo "ğŸ“Š Estado del historial antes del anÃ¡lisis:"
        echo "   - Screening histÃ³ricos: $hist_screening archivos"
        echo "   - Ultra conservadores: $hist_ultra archivos"
        echo "   - AnÃ¡lisis consistencia: $hist_consistency archivos"
        echo "   - Recomendaciones: $hist_rotation archivos"
        echo "   - Reportes: $hist_reports archivos"
        
        # Verificar archivo actual (Ãºltimo anÃ¡lisis)
        if [ -f "weekly_screening_results.json" ]; then
          echo "âœ“ Ãšltimo screening encontrado - serÃ¡ archivado automÃ¡ticamente"
          python3 -c "
import json
try:
    with open('weekly_screening_results.json', 'r') as f:
        data = json.load(f)
    date = data.get('analysis_date', '')[:10]
    symbols = len(data.get('detailed_results', []))
    print(f'   ğŸ“… Fecha: {date} | ğŸ“Š {symbols} sÃ­mbolos')
except:
    print('   âš ï¸ Error leyendo archivo actual')
          "
        else
          echo "â„¹ï¸ Sin screening previo - primera ejecuciÃ³n o anÃ¡lisis inicial"
        fi
        
    - name: 1. Ejecutar screening conservador con gestiÃ³n de historial
      run: |
        echo "ğŸ” PASO 1: Screening conservador mejorado con gestiÃ³n automÃ¡tica de historial..."
        echo "ğŸ“ El sistema archivarÃ¡ automÃ¡ticamente el screening anterior (si existe)"
        echo "ğŸ§¹ AplicarÃ¡ limpieza automÃ¡tica de archivos antiguos"
        
        # Ejecutar screening con gestiÃ³n de historial integrada
        python conservative_screener.py
        
        echo "Verificando resultados del screening con historial..."
        if [ -f "weekly_screening_results.json" ]; then
          echo "âœ… Screening completado exitosamente con gestiÃ³n de historial"
          python3 -c "
import json
with open('weekly_screening_results.json', 'r') as f:
    data = json.load(f)
results = data.get('detailed_results', [])
print(f'ğŸ“Š {len(results)} acciones pasaron filtros conservadores mejorados')
if results:
    # Verificar si tiene el scoring mejorado
    if 'technical_score' in results[0]:
        avg_tech = sum(r.get('technical_score', 0) for r in results) / len(results)
        avg_final = sum(r.get('score', 0) for r in results) / len(results)
        avg_rr = sum(r.get('risk_reward_ratio', 0) for r in results) / len(results)
        print(f'ğŸ“ˆ Score tÃ©cnico promedio: {avg_tech:.1f}')
        print(f'ğŸ¯ Score final promedio: {avg_final:.1f}')
        print(f'âš–ï¸ Risk/Reward promedio: {avg_rr:.1f}:1')
        print('âœ… SCORING MEJORADO Y GESTIÃ“N DE HISTORIAL DETECTADOS')
    else:
        avg_rr = sum(r.get('risk_reward_ratio', 0) for r in results) / len(results)
        print(f'âš–ï¸ Risk/Reward promedio: {avg_rr:.1f}:1')
    
    top_5 = [r['symbol'] for r in results[:5]]
    print(f'ğŸ† Top 5: {top_5}')
    
    # Verificar tipo de anÃ¡lisis
    analysis_type = data.get('analysis_type', 'standard')
    print(f'ğŸ”¬ Tipo de anÃ¡lisis: {analysis_type}')
          "
        else
          echo "âŒ Error en screening - archivo de resultados no encontrado"
          exit 1
        fi
      env:
        PYTHONUNBUFFERED: 1
        
    - name: 2. Analizar consistencia histÃ³rica con archivos mejorados
      run: |
        echo "ğŸ“Š PASO 2: AnÃ¡lisis de consistencia (5 semanas) con gestiÃ³n de historial..."
        echo "ğŸ“ El sistema archivarÃ¡ automÃ¡ticamente el anÃ¡lisis anterior (si existe)"
        echo "ğŸ” BuscarÃ¡ archivos histÃ³ricos en mÃºltiples formatos para mÃ¡xima compatibilidad"
        
        python consistency_analyzer.py
        
        if [ -f "consistency_analysis.json" ]; then
          echo "âœ… AnÃ¡lisis de consistencia completado con gestiÃ³n de historial"
          python3 -c "
import json
with open('consistency_analysis.json', 'r') as f:
    data = json.load(f)
stats = data.get('summary_stats', {})
sources = data.get('data_sources', {})
print(f'ğŸ† Consistent Winners: {stats.get(\"consistent_winners_count\", 0)}')
print(f'ğŸ’ Strong Candidates: {stats.get(\"strong_candidates_count\", 0)}')
print(f'ğŸŒ± Emerging Opportunities: {stats.get(\"emerging_count\", 0)}')
print(f'ğŸ“Š Total sÃ­mbolos Ãºnicos analizados: {stats.get(\"total_unique_symbols\", 0)}')
print(f'ğŸ“š Semanas analizadas: {data.get(\"weeks_analyzed\", 0)}')

# Mostrar fuentes de datos
hist_files = sources.get('historical_files', [])
valid_files = [f for f in hist_files if 'N/A' not in f]
print(f'ğŸ“ Archivos histÃ³ricos vÃ¡lidos: {len(valid_files)}')
          "
        else
          echo "âŒ Error en anÃ¡lisis de consistencia"
          exit 1
        fi
      env:
        PYTHONUNBUFFERED: 1
        
    - name: 3. Generar recomendaciones de rotaciÃ³n con historial
      run: |
        echo "ğŸ¯ PASO 3: Recomendaciones de rotaciÃ³n con anÃ¡lisis multifactorial y gestiÃ³n de historial..."
        echo "ğŸ“ El sistema archivarÃ¡ automÃ¡ticamente las recomendaciones anteriores (si existen)"
        
        python rotation_recommender.py
        
        if [ -f "rotation_recommendations.json" ]; then
          echo "âœ… Recomendaciones de rotaciÃ³n completadas con gestiÃ³n de historial"
          python3 -c "
import json
with open('rotation_recommendations.json', 'r') as f:
    data = json.load(f)
action = data.get('action_summary', {}).get('overall_action', 'NO_ACTION')
strong_buys = len(data.get('action_summary', {}).get('strong_buys', []))
exits = len(data.get('action_summary', {}).get('consider_exits', [])) + len(data.get('action_summary', {}).get('urgent_exits', []))
holds = len(data.get('action_summary', {}).get('holds', []))
print(f'âš¡ AcciÃ³n general: {action}')
print(f'ğŸ”¥ Compras fuertes recomendadas: {strong_buys}')
print(f'âš ï¸ Salidas a considerar: {exits}')
print(f'âœ… Mantener posiciones: {holds}')

# Verificar si es anÃ¡lisis avanzado
analysis_type = data.get('analysis_type', 'standard')
if 'advanced' in analysis_type or 'multifactor' in analysis_type:
    print('ğŸš€ ANÃLISIS MULTIFACTORIAL AVANZADO CON HISTORIAL DETECTADO')
else:
    print('ğŸ“Š AnÃ¡lisis estÃ¡ndar completado')
          "
        else
          echo "âŒ Error en recomendaciones de rotaciÃ³n"
          exit 1
        fi
      env:
        PYTHONUNBUFFERED: 1
        
    - name: 4. Crear reporte semanal mejorado con historial
      run: |
        echo "ğŸ“‹ PASO 4: Generando reporte semanal mejorado con niveles de trading y gestiÃ³n de historial..."
        echo "ğŸ“ El sistema gestionarÃ¡ automÃ¡ticamente el historial de reportes"
        
        python create_weekly_report.py
        
        echo "Verificando reportes generados..."
        if [ -f "docs/data.json" ]; then
          echo "âœ… Dashboard data.json generado"
          python3 -c "
import json
with open('docs/data.json', 'r') as f:
    data = json.load(f)
analysis_type = data.get('analysis_type', 'standard')
top_picks = len(data.get('top_picks', []))
print(f'ğŸ“Š Tipo de anÃ¡lisis: {analysis_type}')
print(f'ğŸ¯ Top picks generados: {top_picks}')

# Verificar caracterÃ­sticas avanzadas
features = []
if 'trading_metrics' in data:
    metrics = data['trading_metrics']
    print(f'âš–ï¸ Avg R/R: {metrics.get(\"avg_risk_reward\", 0):.1f}:1')
    print(f'ğŸ“ˆ Oportunidades alta calidad: {metrics.get(\"high_quality_count\", 0)}')
    features.append('Trading Metrics')

if any('take_profit' in str(pick) for pick in data.get('top_picks', [])):
    features.append('Stop/Target DinÃ¡micos')

if any('technical_score' in str(pick) for pick in data.get('top_picks', [])):
    features.append('Scoring Avanzado')

if features:
    print(f'ğŸš€ CaracterÃ­sticas detectadas: {\" | \".join(features)}')
          "
        else
          echo "âŒ Error generando dashboard data"
          exit 1
        fi
        
        # Verificar reportes Markdown
        ENHANCED_REPORT=$(ls ENHANCED_WEEKLY_REPORT_*.md 2>/dev/null | head -1)
        REGULAR_REPORT=$(ls WEEKLY_REPORT_*.md 2>/dev/null | head -1)
        
        if [ -n "$ENHANCED_REPORT" ]; then
          echo "âœ… Reporte mejorado generado: $ENHANCED_REPORT"
        elif [ -n "$REGULAR_REPORT" ]; then
          echo "âœ… Reporte regular generado: $REGULAR_REPORT"
        else
          echo "âš ï¸ No se generÃ³ reporte Markdown (puede ser normal)"
        fi
      env:
        PYTHONUNBUFFERED: 1
        
    - name: Verificar archivos generados y calidad con historial
      run: |
        echo "=== VERIFICACIÃ“N FINAL DE ARCHIVOS Y GESTIÃ“N DE HISTORIAL ==="
        
        # Archivos principales
        for file in "weekly_screening_results.json" "consistency_analysis.json" "rotation_recommendations.json" "docs/data.json"; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            echo "âœ… $file (${size} bytes)"
          else
            echo "âŒ $file FALTANTE"
          fi
        done
        
        # Verificar estado del historial despuÃ©s del anÃ¡lisis
        echo ""
        echo "=== ESTADO DEL HISTORIAL DESPUÃ‰S DEL ANÃLISIS ==="
        
        hist_screening=$(ls weekly_screening_results_*.json 2>/dev/null | wc -l)
        hist_ultra=$(ls ultra_conservative_results_*.json 2>/dev/null | wc -l)
        hist_consistency=$(ls consistency_analysis_*.json 2>/dev/null | wc -l)
        hist_rotation=$(ls rotation_recommendations_*.json 2>/dev/null | wc -l)
        hist_reports=$(ls *WEEKLY_REPORT*.md 2>/dev/null | wc -l)
        
        echo "ğŸ“Š Historial despuÃ©s del anÃ¡lisis:"
        echo "   - Screening histÃ³ricos: $hist_screening archivos"
        echo "   - Ultra conservadores: $hist_ultra archivos"
        echo "   - AnÃ¡lisis consistencia: $hist_consistency archivos"
        echo "   - Recomendaciones: $hist_rotation archivos"
        echo "   - Reportes: $hist_reports archivos"
        
        # Verificar calidad de datos
        echo ""
        echo "=== VERIFICACIÃ“N DE CALIDAD ==="
        python3 -c "
import json
import os

def check_file_quality(filename, min_size=100):
    if not os.path.exists(filename):
        print(f'âŒ {filename}: No existe')
        return False
    
    size = os.path.getsize(filename)
    if size < min_size:
        print(f'âš ï¸ {filename}: Muy pequeÃ±o ({size} bytes)')
        return False
    
    try:
        with open(filename, 'r') as f:
            data = json.load(f)
        print(f'âœ… {filename}: JSON vÃ¡lido ({size} bytes)')
        return True
    except Exception as e:
        print(f'âŒ {filename}: JSON invÃ¡lido - {e}')
        return False

# Verificar archivos crÃ­ticos
files_ok = 0
files_ok += check_file_quality('weekly_screening_results.json', 1000)
files_ok += check_file_quality('consistency_analysis.json', 500)
files_ok += check_file_quality('rotation_recommendations.json', 500)
files_ok += check_file_quality('docs/data.json', 1000)

print(f'\\nğŸ“Š Resumen: {files_ok}/4 archivos OK')
if files_ok < 3:
    print('âŒ CALIDAD INSUFICIENTE - Revisar logs')
    exit(1)
else:
    print('âœ… CALIDAD ACEPTABLE')
        "
        
        # Mostrar estadÃ­sticas finales
        echo ""
        echo "=== ESTADÃSTICAS FINALES CON HISTORIAL ==="
        python3 -c "
import json
from datetime import datetime

# Cargar datos principales
try:
    with open('weekly_screening_results.json', 'r') as f:
        screening = json.load(f)
    with open('consistency_analysis.json', 'r') as f:
        consistency = json.load(f)
    with open('rotation_recommendations.json', 'r') as f:
        rotation = json.load(f)
        
    # EstadÃ­sticas bÃ¡sicas
    results = screening.get('detailed_results', [])
    total_screened = len(results)
    winners = consistency.get('summary_stats', {}).get('consistent_winners_count', 0)
    action = rotation.get('action_summary', {}).get('overall_action', 'NO_ACTION')
    weeks_analyzed = consistency.get('weeks_analyzed', 0)
    
    print(f'ğŸ“Š Total filtradas: {total_screened}')
    print(f'ğŸ† Consistent winners: {winners}')
    print(f'âš¡ AcciÃ³n requerida: {action}')
    print(f'ğŸ“š Semanas de historial analizadas: {weeks_analyzed}')
    print(f'ğŸ“… AnÃ¡lisis completado: {datetime.now().strftime(\"%Y-%m-%d %H:%M UTC\")}')
    
    # Verificar mejoras aplicadas
    analysis_type = screening.get('analysis_type', 'standard')
    print(f'ğŸ”¬ Tipo de anÃ¡lisis aplicado: {analysis_type}')
    
    # Detectar caracterÃ­sticas mejoradas
    features = []
    if results and 'technical_score' in results[0]:
        features.append('Scoring Avanzado')
    if results and 'rr_bonus' in str(results[0]):
        features.append('R/R Integrado')  
    if 'sustainable_momentum' in analysis_type:
        features.append('Momentum Sostenible')
    if 'timeframe' in str(screening.get('methodology', {})):
        features.append('Rangos por Timeframe')
    if 'historial' in str(consistency.get('data_sources', {})):
        features.append('GestiÃ³n de Historial')
        
    if features:
        print(f'ğŸš€ CARACTERÃSTICAS MEJORADAS: {\", \".join(features)}')
    else:
        print('ğŸ“Š AnÃ¡lisis estÃ¡ndar realizado')
        
except Exception as e:
    print(f'âš ï¸ Error en estadÃ­sticas finales: {e}')
        "
        
    - name: Crear resumen de commit mejorado con historial
      run: |
        echo "=== CREANDO RESUMEN DE COMMIT CON GESTIÃ“N DE HISTORIAL ==="
        
        REPORT_DATE=$(date +%Y-%m-%d)
        
        # Extraer informaciÃ³n clave
        python3 -c "
import json
from datetime import datetime

try:
    # Cargar datos
    with open('weekly_screening_results.json', 'r') as f:
        screening = json.load(f)
    with open('consistency_analysis.json', 'r') as f:
        consistency = json.load(f)
    with open('rotation_recommendations.json', 'r') as f:
        rotation = json.load(f)
    
    # Extraer informaciÃ³n
    results = screening.get('detailed_results', [])
    top_symbols = [r['symbol'] for r in results[:5]]
    winners_count = consistency.get('summary_stats', {}).get('consistent_winners_count', 0)
    action = rotation.get('action_summary', {}).get('overall_action', 'NO_ACTION')
    weeks_analyzed = consistency.get('weeks_analyzed', 0)
    
    # MÃ©tricas de trading
    trading_metrics = ''
    if results:
        if 'technical_score' in results[0]:
            avg_tech = sum(r.get('technical_score', 0) for r in results) / len(results)
            avg_final = sum(r.get('score', 0) for r in results) / len(results)
            trading_metrics = f' | Tech: {avg_tech:.0f} Final: {avg_final:.0f}'
        
        avg_rr = sum(r.get('risk_reward_ratio', 0) for r in results) / len(results)
        high_quality = len([r for r in results if r.get('risk_reward_ratio', 0) > 2.5])
        trading_metrics += f' | R/R: {avg_rr:.1f}:1 | HQ: {high_quality}'
    
    # Detectar tipo de anÃ¡lisis
    analysis_type = screening.get('analysis_type', 'standard')
    if 'sustainable_momentum' in analysis_type:
        analysis_label = 'Sustainable Momentum + Historial'
    elif 'enhanced' in analysis_type:
        analysis_label = 'Enhanced + Historial'
    else:
        analysis_label = 'Standard + Historial'
    
    # Crear mensaje
    with open('commit_message.txt', 'w') as f:
        f.write(f'ğŸ“ˆ {analysis_label} Analysis $REPORT_DATE\\n\\n')
        f.write(f'ğŸ† Top 5: {\", \".join(top_symbols) if top_symbols else \"None\"}\\n')
        f.write(f'ğŸ¯ Consistent Winners: {winners_count}\\n')
        f.write(f'âš¡ Action: {action}\\n')
        f.write(f'ğŸ“Š Filtered: {len(results)}{trading_metrics}\\n')
        f.write(f'ğŸ“š History: {weeks_analyzed} weeks analyzed\\n\\n')
        f.write(f'ğŸ¤– Enhanced Bot v2.1 + Auto History - {datetime.now().strftime(\"%H:%M UTC\")}\\n')
    
    print('âœ… Commit message con historial generado')
    
except Exception as e:
    print(f'âŒ Error generando commit message: {e}')
    # Fallback message
    with open('commit_message.txt', 'w') as f:
        f.write(f'ğŸ“Š Weekly Analysis + Auto History $REPORT_DATE\\n\\nGenerated by Enhanced Conservative Trading Bot with History Management\\n')
        " REPORT_DATE="$REPORT_DATE"
        
        cat commit_message.txt
        
    - name: Limpiar archivos antiguos con gestiÃ³n inteligente de historial
      run: |
        echo "ğŸ§¹ Limpieza automÃ¡tica inteligente de historial..."
        
        # FunciÃ³n para mantener solo N archivos mÃ¡s recientes por tipo
        cleanup_files() {
            local pattern=$1
            local keep_count=$2
            local file_type=$3
            
            echo "ğŸ“‚ Procesando $file_type (patrÃ³n: $pattern)..."
            
            # Buscar archivos que coincidan con el patrÃ³n
            files=$(ls -t $pattern 2>/dev/null || true)
            
            if [ -z "$files" ]; then
                echo "   âœ… No hay archivos $file_type para procesar"
                return
            fi
            
            # Contar archivos encontrados
            file_count=$(echo "$files" | wc -l)
            echo "   ğŸ“Š Encontrados: $file_count archivos"
            
            # Si hay menos o igual archivos que el lÃ­mite, no hacer nada
            if [ $file_count -le $keep_count ]; then
                echo "   âœ… No es necesario limpiar (â‰¤ $keep_count archivos)"
                return
            fi
            
            # Identificar archivos a eliminar (los mÃ¡s antiguos)
            to_delete=$(echo "$files" | tail -n +$((keep_count + 1)))
            deleted_count=0
            
            # Eliminar archivos antiguos
            for file in $to_delete; do
                if [ -f "$file" ]; then
                    echo "   ğŸ—‘ï¸ Eliminando archivo antiguo: $file"
                    rm -f "$file"
                    deleted_count=$((deleted_count + 1))
                fi
            done
            
            # Mostrar resumen
            remaining=$(ls $pattern 2>/dev/null | wc -l)
            echo "   âœ… $file_type: Eliminados $deleted_count, mantenidos $remaining"
        }
        
        echo ""
        echo "ğŸ”„ Iniciando limpieza por categorÃ­as con lÃ­mites optimizados..."
        echo ""
        
        # Limpiar archivos histÃ³ricos de screening (mantener 6 semanas)
        cleanup_files "weekly_screening_results_*.json" 6 "Screening histÃ³ricos"
        
        # Limpiar resultados ultra conservadores completos (mantener 6) 
        cleanup_files "ultra_conservative_results_*.json" 6 "Resultados ultra conservadores"
        
        # Limpiar reportes semanales (mantener 4)
        cleanup_files "ENHANCED_WEEKLY_REPORT*.md" 4 "Reportes semanales mejorados"
        cleanup_files "WEEKLY_REPORT*.md" 4 "Reportes semanales estÃ¡ndar"
        
        # Limpiar anÃ¡lisis de consistencia histÃ³ricos (mantener 4)
        cleanup_files "consistency_analysis_*.json" 4 "AnÃ¡lisis de consistencia"
        
        # Limpiar recomendaciones de rotaciÃ³n histÃ³ricas (mantener 4)
        cleanup_files "rotation_recommendations_*.json" 4 "Recomendaciones de rotaciÃ³n"
        
        echo ""
        echo "ğŸ“Š RESUMEN FINAL DE ARCHIVOS:"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Mostrar archivos actuales (principales del workflow)
        echo "ğŸ”‘ ARCHIVOS PRINCIPALES (siempre presentes):"
        for main_file in "weekly_screening_results.json" "consistency_analysis.json" "rotation_recommendations.json" "docs/data.json"; do
            if [ -f "$main_file" ]; then
                size=$(stat -c%s "$main_file" 2>/dev/null || echo "unknown")
                echo "   âœ… $main_file ($size bytes)"
            else
                echo "   âŒ $main_file (faltante)"
            fi
        done
        
        echo ""
        echo "ğŸ“š ARCHIVOS DE HISTORIAL (gestionados automÃ¡ticamente):"
        
        # Contar y mostrar archivos histÃ³ricos
        hist_screening=$(ls weekly_screening_results_*.json 2>/dev/null | wc -l)
        hist_ultra=$(ls ultra_conservative_results_*.json 2>/dev/null | wc -l)
        hist_reports=$(ls *WEEKLY_REPORT*.md 2>/dev/null | wc -l)
        hist_consistency=$(ls consistency_analysis_*.json 2>/dev/null | wc -l)
        hist_rotation=$(ls rotation_recommendations_*.json 2>/dev/null | wc -l)
        
        echo "   ğŸ“ˆ Screening histÃ³ricos: $hist_screening archivos (mÃ¡x 6)"
        echo "   ğŸ”¬ Ultra conservadores: $hist_ultra archivos (mÃ¡x 6)"
        echo "   ğŸ“‹ Reportes: $hist_reports archivos (mÃ¡x 4)"
        echo "   ğŸ”„ Consistencia: $hist_consistency archivos (mÃ¡x 4)"
        echo "   ğŸ¯ RotaciÃ³n: $hist_rotation archivos (mÃ¡x 4)"
        
        # Calcular espacio total aproximado
        total_files=$((1 + hist_screening + hist_ultra + hist_reports + hist_consistency + hist_rotation))
        echo ""
        echo "ğŸ“Š Total archivos en repositorio: ~$total_files"
        echo "ğŸ’¾ Espacio estimado: <50MB (GitHub limit: 1GB)"
        echo ""
        echo "âœ… GESTIÃ“N DE HISTORIAL COMPLETADA"
        echo "   - Archivos principales: Actualizados"
        echo "   - Historial: Mantenido automÃ¡ticamente"
        echo "   - Limpieza: Aplicada segÃºn retenciÃ³n definida"
        echo "   - PrÃ³xima ejecuciÃ³n: SÃ¡bado $(date -d '+7 days' '+%Y-%m-%d 10:00 EspaÃ±a')"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
    - name: Commit resultados semanales con historial completo
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message_file: commit_message.txt
        file_pattern: 'weekly_screening_results.json weekly_screening_results_*.json consistency_analysis.json consistency_analysis_*.json rotation_recommendations.json rotation_recommendations_*.json docs/data.json *WEEKLY_REPORT*.md ultra_conservative_results*.json'
        
    - name: Configurar Pages
      uses: actions/configure-pages@v4
      
    - name: Subir artefacto de Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs'
        
    - name: Desplegar a GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Resumen final con gestiÃ³n de historial
      run: |
        echo "================================="
        echo "âœ… ANÃLISIS CONSERVADOR MEJORADO CON HISTORIAL COMPLETADO"
        echo "================================="
        echo "Fecha: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "ğŸ“Š Dashboard: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“‹ Reportes: Guardados en repositorio con historial"
        echo "ğŸ”„ PrÃ³ximo anÃ¡lisis: $(date -d '+7 days' '+%Y-%m-%d 10:00 EspaÃ±a')"
        echo ""
        echo "ğŸš€ CARACTERÃSTICAS APLICADAS:"
        echo "   âœ… Filtros de entrada flexibles (rebotes MA50)"
        echo "   âœ… Momentum sostenible (rangos por timeframe)"
        echo "   âœ… Scoring balanceado (tÃ©cnico + R/R)"
        echo "   âœ… Stop-loss dinÃ¡mico ultra conservador (â‰¤10%)"
        echo "   âœ… Take-profit con media y rangos realistas"
        echo "   âœ… Dashboard con niveles de trading"
        echo "   ğŸ†• GESTIÃ“N AUTOMÃTICA DE HISTORIAL:"
        echo "       â€¢ Archivado automÃ¡tico de anÃ¡lisis anteriores"
        echo "       â€¢ Limpieza inteligente (mantiene 4-6 semanas)"
        echo "       â€¢ Compatibilidad con mÃºltiples formatos"
        echo "       â€¢ AnÃ¡lisis de consistencia con historial real"
        echo "       â€¢ Sin intervenciÃ³n manual requerida"
        echo "================================="